---
format: 
  html:
    css: style.css
    embed-resources: false
    anchor-sections: false
---

::: {.grid  .document-header}
::: {.g-col-12 .g-col-md-2}
<img class="logo" src="assets/logo-dorado.png">
:::
::: {.g-col-12 .g-col-md-10 .text-center .header-text}
<h1>Reporte diario del mercado cambiario</h1>
Subdirección de Asuntos cambiarios <br> 03 marzo de 2025
:::
:::

----

```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(dplyr)
library(htmltools)
library(reactable)
library(sparkline)
library(glue)
```



```{r echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
tags$dl(
  class = "stats-container-v1",
  tags$div(
    class = "stat-item-v1",
    tags$dt(class = "stat-name-v1", "Tasa de venta"),
    tags$dd(class = "stat-value-v1", "DOP 62.5")
  ),
  tags$div(
    class = "stat-item-v1",
    tags$dt(class = "stat-name-v1", "Tasa de compra"),
    tags$dd(class = "stat-value-v1", "DOP 60.2")
  ),
  tags$div(
    class = "stat-item-v1",
    tags$dt(class = "stat-name-v1", "Entidades consultadas"),
    tags$dd(class = "stat-value-v1", "14")
  )
)
```


```{r echo=FALSE, include=FALSE}

tags$dl(
  class = "stats-container-v2",
  tags$div(
    class = "stat-item-v2",
    tags$div(
      class = "stat-header-v2",
      tags$dt(class = "stat-name-v2", "Tasa de venta"),
      tags$dd(class = "stat-change-v2 change-positive", "+0.37%")
    ),
    tags$dd(class = "stat-value-v2", "DOP 62.3")
  ),
  
  tags$div(
    class = "stat-item-v2",
    tags$div(
      class = "stat-header-v2",
      tags$dt(class = "stat-name-v2", "Tasa de compra"),
      tags$dd(class = "stat-change-v2 change-positive", "+0.35")
    ),
    tags$dd(class = "stat-value-v2", "DOP 60.8")
  ),
  
  tags$div(
    class = "stat-item-v2",
    tags$div(
      class = "stat-header-v2",
      tags$dt(class = "stat-name-v2", "Entidades consultadas"),
      tags$dd(class = "stat-change-v2 change-negative", "-2")
    ),
    tags$dd(class = "stat-value-v2", "14")
  )
)
```

<div class="info-header">
<div class="info-container">
<svg xmlns="http://www.w3.org/2000/svg" class="icon" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
  <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z" />
</svg>
Promedio del día
</div>

<div class="info-container">
<svg xmlns="http://www.w3.org/2000/svg" class="icon" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
  <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />
</svg>
Comparación respecto al 02 de marzo de 2025
</div>
</div>

```{r stats_cards, echo=FALSE}
 tags$dl(
  class = "stats-container",
  
  tags$div(
    tags$div(
      class = "stat-header-v2",
      tags$dt(class = "stat-name", "Tasa de venta"),
      tags$div(
        class = "stat-change increase",
        "+0.3"
      )
    ),
    tags$dd(
      class = "stat-details",
      tags$div(
        class = "stat-value",
        "DOP 62.5",
        tags$span(class = "stat-previous", "ayer: DOP 62.3")
      )
    )
  ),

  tags$div(
    tags$div(
      class = "stat-header-v2",
      tags$dt(class = "stat-name", "Tasa de compra"),
      tags$div(
        class = "stat-change increase",
        "+0.4"
      )
    ),
    tags$dd(
      class = "stat-details",
      tags$div(
        class = "stat-value",
        "DOP 61.1",
        tags$span(class = "stat-previous", "ayer: DOP 60.7")
      )
    )
  ),
  
  tags$div(
    tags$dt(class = "stat-name", "Entidades consultadas"),
    tags$dd(
      class = "stat-details",
      tags$div(
        class = "stat-value",
        "14"
      )
    )
  )
)
```



```{r trend_indicator_definition, echo=FALSE}
# Icon to indicate trend: unchanged, up, down, or new
trend_indicator <- function(variation) {
  value <- dplyr::case_when(
    variation == 0 ~ "unchanged",
    variation  > 0 ~ "up",
    variation   < 0 ~ "down"
  )
  
  label <- switch(
    value,
    unchanged = "Unchanged",
    up = "Trending up",
    down = "Trending down", 
    new = "New"
  )
  
  # Add img role and tooltip/label for accessibility
  args <- list(role = "img", title = label)
  
  if (value == "unchanged") {
    args <- c(args, list("–", style = "color: #6B7280; font-weight: 700"))
  } else if (value == "up") {
    args <- c(args, list(shiny::icon("caret-up"), style = "color: #22C55E"))
  } else if (value == "down") {
    args <- c(args, list(shiny::icon("caret-down"), style = "color: #EF4444"))
  } else {
    args <- c(args, list(shiny::icon("circle"), style = "color: #2e77d0; font-size: 0.6rem"))
  }
  do.call(htmltools::tags$span, args)
}
```


```{r tasas_table, echo=FALSE}
tasas_raw <- readr::read_rds(here::here("data/from_banks/rds/2025-03-03.rds")) |>
  summarise(
    across(c(buy, sell), \(x) mean(x, na.rm = TRUE)),
    .by = bank
  )

set.seed(123)

tasas_to_table <- tasas_raw |>
  mutate(gap = sell - buy) |>
  arrange(desc(buy)) |>
  select(Entidad = bank, Venta = sell, Compra = buy, Brecha = gap) |>
  mutate(
    evolucion = Venta,
    d_compra = sample(seq(-0.3, 0.3, by = 0.01), size = n()),
    d_venta = sample(seq(-0.3, 0.3, by = 0.01), size = n())
  ) 

tasas_to_table |> 
  reactable(
    compact = TRUE,
    pagination = FALSE,
    defaultColDef = colDef(
      headerClass = "table-header",
      format = colFormat(separators = TRUE, digits = 2),
      minWidth = 50,
      footerStyle = list(fontWeight = "bold")
    ),
    class = "tasas-table",
    theme = reactableTheme(cellPadding = "8px 12px"),
    highlight = TRUE, 
    striped = TRUE,
    columns = list(
      d_compra = colDef(show = FALSE),
      d_venta = colDef(show = FALSE),
      Compra = colDef(
        align = "right",
        cell = \(compra, index) {
          d_compra <- tasas_to_table$d_compra[index] 
          trend_icon <-  trend_indicator(d_compra)
          d_compra <- scales::comma(d_compra, 0.01, prefix = ifelse(d_compra > 0, "+", ""))
          compra <- scales::comma(compra, 0.01)
          span(
            span(span(style="margin-right: 3px; display: inline-block;", trend_icon), compra),
            span(class = "var", style="color: #6a7282; margin-left: 5px;", glue("({d_compra})"))
          )
        }
      ),
      Venta = colDef(
        align = "right",
        cell = \(venta, index) {
          d_venta <- tasas_to_table$d_venta[index] 
          trend_icon <-  trend_indicator(d_venta)
          d_venta <- scales::comma(d_venta, 0.01, prefix = ifelse(d_venta > 0, "+", ""))
          venta <- scales::comma(venta, 0.01)
          span(
            span(span(style="margin-right: 3px; display: inline-block;", trend_icon), venta), 
            span(class = "var", style="color: #6a7282; margin-left: 5px;", glue("({d_venta})"))
          )
        }
      ),
      evolucion = colDef(
        name = "",
        cell = function(end_value, index) {
          values <-  c(rnorm(mean = end_value - 0.3, sd = 0.1, n = 20), end_value) |>
            round(2)
          sparkline(values)
        }
      )
    )
  )
```

